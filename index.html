<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AquaGuard Permit Checking Tool</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#0f172a;
  --card:#111827;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --ok:#22c55e;
  --warn:#f97316;
  --bad:#ef4444;
}
body{
  margin:0;
  font-family:system-ui,Segoe UI,Roboto;
  background:var(--bg);
  color:var(--text);
}
.container{max-width:900px;margin:auto;padding:16px}
.card{background:var(--card);border-radius:14px;padding:16px;margin-bottom:16px}
input,select,textarea,button{
  width:100%;padding:10px;border-radius:10px;
  border:1px solid #374151;background:#020617;color:var(--text)
}
button{cursor:pointer;font-weight:600}
.primary{background:var(--ok);color:#052e16;border:none}
.tabbar{display:flex;gap:10px;margin:10px 0}
.tab{flex:1;text-align:center;padding:10px;border-radius:10px;border:1px solid #374151;cursor:pointer}
.tab.active{background:#020617}
.hidden{display:none}
.tag{display:inline-block;padding:4px 10px;border-radius:999px;font-size:.8rem;border:1px solid #374151;margin-right:6px}
.result{margin-top:12px;padding:14px;border-radius:12px}
.result.ok{background:rgba(34,197,94,.15)}
.result.warn{background:rgba(249,115,22,.15)}
.result.bad{background:rgba(239,68,68,.15)}
.confbar{height:10px;border-radius:999px;background:#1f2937;overflow:hidden}
.confbar > div{height:100%;width:0;transition:.4s}
small{color:var(--muted)}
img{max-width:100%}
</style>
</head>

<body>
<div class="container">

<!-- Banner -->
<img src="aquaguard-logo.png" alt="AquaGuard Logo" style="display:block;margin:auto;max-width:260px">

<div class="tabbar">
  <div class="tab active" onclick="showTab('checker')">Checker</div>
  <div class="tab" onclick="showTab('instructions')">Instructions</div>
</div>

<!-- CHECKER -->
<div id="checker" class="card">

<label>Property Address / City / ZIP (Georgia)</label>
<textarea id="address" rows="3"
placeholder="706 Springs Street Smyrna GA 30080"></textarea>

<label>Service Type</label>
<select id="service">
  <option value="slab_piers">Slab Piers (Exempt)</option>
  <option value="helical_piers">Helical Piers</option>
  <option value="push_piers">Push Piers</option>
  <option value="wall_anchors">Wall Anchors (All Types)</option>
  <option value="other_structural">Other Structural Work</option>
</select>

<button class="primary" onclick="checkPermit()">Check Permit</button>

<div style="margin-top:10px">
  <span class="tag" id="detected">Detected: —</span>
  <span class="tag" id="confidenceTag">Confidence: —</span>
</div>

<div style="margin-top:8px">
  <div class="confbar"><div id="confidenceBar"></div></div>
</div>

<div id="result" class="result hidden"></div>

<hr>

<button onclick="openQPublic()">Open qPublic</button>

<hr>

<h3>Export Audit PDF</h3>
<label>Inspector Name (CFI)</label>
<input id="inspName" placeholder="Matthew Urbanski">

<label>Inspector Initials</label>
<input id="inspInit" placeholder="MU">

<button onclick="exportPDF()">Export PDF</button>

<div id="audit" style="margin-top:12px"></div>
</div>

<!-- INSTRUCTIONS -->
<div id="instructions" class="card hidden">
<h3>How to Use This Tool</h3>
<ul>
<li>Paste a full address, city, ZIP, or any combination.</li>
<li>The tool automatically resolves city and county.</li>
<li>Structural services generally require permits.</li>
<li>Slab piers are exempt statewide.</li>
<li>Confidence reflects data quality, not legality.</li>
<li>Always verify parcels in qPublic.</li>
</ul>
<p><strong>Ruleset:</strong> AquaGuard Permit Instructions (1-22-2026)</p>
</div>

</div>

<script>
function showTab(id){
  document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  event.target.classList.add('active');
}

const PERMIT_COUNTIES=["Cobb","Cherokee","Fulton","DeKalb","Gwinnett","Butts"];

const ZIP_TO_COUNTY={
  "30080":"Cobb","30115":"Cherokee","30339":"Fulton"
};

let auditData={};

function normalize(s){
  return s? s.replace(/ County$/i,"").trim(): "";
}

function extractCity(addr){
  const keys=["city","town","municipality","suburb","village","locality","neighbourhood","hamlet"];
  for(const k of keys){ if(addr[k]) return normalize(addr[k]); }
  return "";
}

async function geocode(q){
  const url=`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(q)}`;
  const r=await fetch(url);
  const j=await r.json();
  return j[0];
}

async function checkPermit(){
  const address=document.getElementById("address").value.replace(/\s+/g," ").trim();
  const service=document.getElementById("service").value;
  let city="",county="",confidence="Low",score=30,reason=[];

  try{
    const geo=await geocode(address);
    const a=geo.address||{};
    city=extractCity(a);
    county=normalize(a.county);
    const zip=a.postcode;

    if(!county && zip && ZIP_TO_COUNTY[zip]){
      county=ZIP_TO_COUNTY[zip];
      confidence="Medium";score=60;
      reason.push("County derived from ZIP fallback.");
    }
    if(county && city){
      confidence="High";score=90;
    }

    if(service==="slab_piers"){
      showResult("ok","No Permit Required","Slab piers are exempt statewide.");
    }else if(PERMIT_COUNTIES.includes(county)){
      showResult("bad","Permit Required",`${county} County requires permits.`);
    }else{
      showResult("warn","Check / Try","Jurisdiction unclear.");
    }

    document.getElementById("detected").textContent=`Detected: ${city||"Unknown"}, ${county||"Unknown County"}`;
    document.getElementById("confidenceTag").textContent=`Confidence: ${confidence}`;
    updateBar(score,confidence);

    auditData={address,city,county,confidence,service,reason,time:new Date().toLocaleString()};
    document.getElementById("audit").innerHTML=
      `<small><pre>${JSON.stringify(auditData,null,2)}</pre></small>`;

  }catch(e){
    showResult("warn","Check / Try","No geocoder match.");
  }
}

function updateBar(score,conf){
  const bar=document.getElementById("confidenceBar");
  bar.style.width=score+"%";
  bar.style.background= conf==="High"?"#22c55e":conf==="Medium"?"#f97316":"#ef4444";
}

function showResult(type,title,msg){
  const r=document.getElementById("result");
  r.className=`result ${type}`;
  r.innerHTML=`<strong>${title}</strong><br>${msg}`;
  r.classList.remove("hidden");
}

function openQPublic(){
  window.open("https://qpublic.schneidercorp.com","_blank");
}

function exportPDF(){
  if(!document.getElementById("inspName").value||!document.getElementById("inspInit").value){
    alert("Inspector name and initials required.");
    return;
  }
  const {jsPDF}=window.jspdf;
  const d=new jsPDF();
  d.text("AquaGuard Permit Audit",10,10);
  d.text(JSON.stringify(auditData,null,2),10,20);
  d.save("permit_audit.pdf");
}
</script>
</body>
</html>
