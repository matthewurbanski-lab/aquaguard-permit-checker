<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AquaGuard Permit Checking Tool</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;
  --accent:#22c55e;--warn:#f97316;--danger:#ef4444;
}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto;}
.container{max-width:960px;margin:0 auto;padding:16px;}
.header{text-align:center;margin:20px 0;}
.header img{max-width:100%;border-radius:12px;}
.card{background:var(--card);border-radius:12px;padding:16px;margin-bottom:16px;}
label{display:block;margin-top:10px;color:var(--muted);}
textarea,select,input{
  width:100%;padding:10px;border-radius:8px;
  border:1px solid #374151;background:#0b1220;color:var(--text);
}
textarea{min-height:90px;}
button{padding:10px 14px;border-radius:8px;border:0;font-weight:600;cursor:pointer;}
.primary{background:var(--accent);color:#052e16;}
.ghost{background:#0b1220;border:1px solid #374151;color:var(--text);}
.result{margin-top:14px;padding:14px;border-radius:12px;}
.yes{background:rgba(239,68,68,.18);}
.no{background:rgba(16,185,129,.18);}
.maybe{background:rgba(249,115,22,.18);}
.tag{display:inline-block;margin-right:8px;padding:4px 8px;border-radius:999px;font-size:.75rem;border:1px solid #374151;color:var(--muted);}
.tabs{display:flex;gap:8px;margin-bottom:16px;}
.tab{padding:8px 12px;border-radius:8px;border:1px solid #374151;cursor:pointer;}
.tab.active{background:#0b1220;}
footer{font-size:.85rem;color:var(--muted);margin-top:24px;}
a{color:#93c5fd;text-decoration:none}

/* Confidence bar */
.bar-bg{background:#1f2937;border-radius:999px;height:10px;overflow:hidden}
.bar-fill{height:100%;width:0%;transition:width .4s ease}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;}
.modal-content{background:#0b1220;border-radius:12px;max-width:420px;width:100%;padding:20px;}
.modal-actions{display:flex;gap:8px;margin-top:16px}
</style>
</head>

<body>
<div class="container">

<div class="header">
  <img src="aquaguard-logo.PNG" alt="AquaGuard Permit Checking Tool">
</div>

<div class="tabs">
  <div class="tab active" onclick="showTab('checker')">Checker</div>
  <div class="tab" onclick="showTab('instructions')">Instructions</div>
</div>

<!-- CHECKER -->
<div id="checker">

<div class="card">
  <label>Property Address / City / ZIP (Georgia)</label>
  <textarea id="address"></textarea>

  <label>Work Type</label>
  <select id="work">
    <option value="structural">Structural Work</option>
    <option value="slab">Slab Piers</option>
  </select>

  <button class="primary" style="margin-top:12px" onclick="runCheck()">Check Permit</button>

  <div style="margin-top:10px">
    <span class="tag" id="detected">Detected: —</span>
    <span class="tag" id="confidenceText">Confidence: —</span>
  </div>

  <div style="margin-top:10px">
    <div class="bar-bg">
      <div id="confidenceBar" class="bar-fill"></div>
    </div>
  </div>

  <div id="result" class="result maybe" style="display:none"></div>
</div>

<div id="auditCard" class="card" style="display:none">
  <strong>Decision Details (Audit Trail)</strong>
  <ul id="audit"></ul>
  <button class="ghost" onclick="openPDFModal()">Export Audit as PDF</button>
</div>

</div>

<!-- INSTRUCTIONS -->
<div id="instructions" style="display:none">
<div class="card">
<h3>How This Tool Works</h3>
<ul>
<li>Accepts full addresses, partial addresses, city names, ZIP codes, or any combination</li>
<li>Resolves jurisdiction using geocoder + city + ZIP fallbacks</li>
<li>Displays a confidence bar indicating match strength</li>
<li>Permit checks do not require inspector info</li>
<li>PDF export is restricted to Certified Field Inspectors (CFIs)</li>
</ul>
<p>Jurisdiction must always be verified via qPublic.</p>
</div>
</div>

<footer>
<strong>Ruleset:</strong> 1-22-2026<br><br>
<strong>Tool created by:</strong><br>
Matthew Urbanski, CFI<br>
<a href="mailto:Matthew.Urbanski@AquaGuard.net">Matthew.Urbanski@AquaGuard.net</a><br>
<a href="tel:14705681681">470-568-1681</a><br><br>
<a href="Permit_Instructions_2026-01-22.pdf" target="_blank">View official permit instructions (PDF)</a><br><br>
<small>Guidance only. Jurisdiction must be verified via qPublic.</small>
</footer>

</div>

<!-- PDF MODAL -->
<div class="modal" id="pdfModal">
  <div class="modal-content">
    <h3>Export Permit Audit (PDF)</h3>
    <label>Inspector Name</label>
    <input id="pdfInspectorName">
    <label>Inspector Initials</label>
    <input id="pdfInspectorInitials">
    <label style="margin-top:10px">
      <input type="checkbox" id="pdfCFI">
      I certify that I am a Certified Field Inspector (CFI)
    </label>
    <div class="modal-actions">
      <button class="ghost" onclick="closePDFModal()">Cancel</button>
      <button class="primary" onclick="exportPDF()">Export PDF</button>
    </div>
  </div>
</div>

<script>
const PERMIT_COUNTIES=["Cobb","DeKalb","Fulton","Gwinnett","Cherokee","Butts"];
const CITY_TO_COUNTY={
  "Smyrna":"Cobb","Marietta":"Cobb","Kennesaw":"Cobb",
  "Atlanta":"Fulton","Sandy Springs":"Fulton","Roswell":"Fulton","Alpharetta":"Fulton",
  "Canton":"Cherokee","Woodstock":"Cherokee",
  "Lawrenceville":"Gwinnett","Duluth":"Gwinnett",
  "Decatur":"DeKalb","Brookhaven":"DeKalb","Stone Mountain":"DeKalb"
};

let auditData={};

function showTab(t){
  checker.style.display=t==="checker"?"block":"none";
  instructions.style.display=t==="instructions"?"block":"none";
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  document.querySelectorAll(".tab")[t==="checker"?0:1].classList.add("active");
}

function cleanInput(s){return s.replace(/\n+/g," ").replace(/\s+/g," ").trim();}
function norm(s){return s?s.replace(/\b\w/g,c=>c.toUpperCase()).replace(" County",""):"";}

async function geocode(q){
  const url=`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=3&countrycodes=us&state=Georgia&q=${encodeURIComponent(q)}`;
  const r=await fetch(url);return await r.json();
}

async function runCheck(){
  const raw=address.value;
  const work=work.value;
  const cleaned=cleanInput(raw);

  let city="",county="",confidence="Low",score=30;
  const results=await geocode(cleaned);

  if(results.length){
    const a=results[0].address||{};
    city=norm(a.city||a.town||a.suburb||a.municipality||a.village||"");
    county=norm(a.county||"");
    if(city||county){confidence="Medium";score=60;}
  }
  if(!county && CITY_TO_COUNTY[city]){county=CITY_TO_COUNTY[city];confidence="Medium";score=60;}
  if(PERMIT_COUNTIES.includes(county)){confidence="High";score=90;}

  let decision="Check / Try",reason="Jurisdiction unclear.";
  if(work==="slab"){decision="No Permit Required";reason="Slab piers exempt statewide.";}
  else if(PERMIT_COUNTIES.includes(county)){decision="Permit Required";reason=`${county} County requires permits.`;}

  detected.textContent=`Detected: ${city||"Unknown"}, ${county||"Unknown"} County`;
  confidenceText.textContent=`Confidence: ${confidence}`;

  const bar=confidenceBar;
  bar.style.width=score+"%";
  bar.style.background=confidence==="High"?"#22c55e":confidence==="Medium"?"#f97316":"#ef4444";

  result.style.display="block";
  result.innerHTML=`<strong>${decision}</strong><br>${reason}`;
  auditCard.style.display="block";

  auditData={cleaned,city,county,confidence,score,decision,reason,time:new Date().toLocaleString()};
  audit.innerHTML=Object.entries(auditData).map(([k,v])=>`<li><strong>${k}:</strong> ${v}</li>`).join("");
}

function openPDFModal(){pdfModal.style.display="flex";}
function closePDFModal(){pdfModal.style.display="none";}

function exportPDF(){
  const name=pdfInspectorName.value.trim();
  const initials=pdfInspectorInitials.value.trim();
  if(!name||!initials||!pdfCFI.checked){alert("Inspector name, initials, and CFI certification required.");return;}

  const {jsPDF}=window.jspdf;
  const doc=new jsPDF();
  let y=15;

  doc.setFontSize(16);
  doc.text("AquaGuard Permit Audit Summary",105,y,{align:"center"});
  y+=10;

  const section=(t,l)=>{
    doc.setFont(undefined,"bold");doc.text(t,10,y);y+=6;
    doc.setFont(undefined,"normal");
    l.forEach(x=>{
      const w=doc.splitTextToSize(x,180);
      doc.text(w,10,y);y+=w.length*6;
    });
    y+=4;
  };

  section("Inspector",[`${name} (${initials})`]);
  section("Property Input",[auditData.cleaned]);
  section("Jurisdiction",[
    `City: ${auditData.city||"Unknown"}`,
    `County: ${auditData.county||"Unknown"}`,
    `Confidence: ${auditData.confidence}`
  ]);

  // Confidence bar
  doc.setFillColor(220,220,220);
  doc.rect(10,y,180,8,"F");
  doc.setFillColor(
    auditData.confidence==="High"?34:auditData.confidence==="Medium"?249:239,
    auditData.confidence==="High"?197:auditData.confidence==="Medium"?115:68,
    auditData.confidence==="High"?94:auditData.confidence==="Medium"?22:68
  );
  doc.rect(10,y,180*(auditData.score/100),8,"F");
  y+=14;

  section("Decision",[auditData.decision,`Reason: ${auditData.reason}`]);
  section("Timestamp",[auditData.time]);

  doc.setFontSize(9);
  doc.text("CFI-certified internal guidance only. Jurisdiction must be verified via qPublic.",10,285);
  doc.save(`permit-audit-${Date.now()}.pdf`);
  closePDFModal();
}
</script>

</body>
</html>
