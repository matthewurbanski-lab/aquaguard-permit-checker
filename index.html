<!
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
}
.container{
  max-width:960px;
  margin:auto;
  padding:16px;
}
.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:14px;
  padding:16px;
  margin-bottom:16px;
}
img.logo{
  display:block;
  margin:0 auto 12px;
  max-width:300px;
}
img.creator{
  display:block;
  margin:10px auto 6px;
  max-width:120px;
  border-radius:12px;
}
.tabs{
  display:flex;
  gap:10px;
  margin-bottom:12px;
}
.tab{
  flex:1;
  padding:10px;
  text-align:center;
  border:1px solid var(--border);
  border-radius:10px;
  cursor:pointer;
}
.tab.active{background:#020617}
.hidden{display:none}
label{display:block;margin:10px 0 4px;color:var(--muted)}
textarea,input,select,button{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#020617;
  color:var(--text);
}
button.primary{
  background:var(--green);
  color:#052e16;
  font-weight:700;
  border:none;
  margin-top:10px;
}
.tag{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  font-size:.8rem;
  margin-right:6px;
}
.result{
  margin-top:12px;
  padding:14px;
  border-radius:12px;
}
.result.ok{background:rgba(34,197,94,.15)}
.result.warn{background:rgba(249,115,22,.15)}
.result.bad{background:rgba(239,68,68,.15)}
.confbar{
  height:10px;
  background:#1f2937;
  border-radius:999px;
  overflow:hidden;
  margin-top:6px;
}
.confbar > div{height:100%;width:0;transition:.4s}
small{color:var(--muted)}
hr{border:0;border-top:1px solid var(--border);margin:16px 0}
footer{text-align:center}
a{color:#93c5fd;text-decoration:none}
</style>
</head>

<body>
<div class="container">

<img src="aquaguard-logo.PNG" class="logo" alt="AquaGuard Foundation Solutions">

<div class="tabs">
  <div class="tab active" onclick="showTab('checker', this)">Checker</div>
  <div class="tab" onclick="showTab('instructions', this)">Instructions</div>
</div>

<!-- CHECKER -->
<div id="checker" class="card">

<label>Property Address / City / ZIP (Georgia)</label>
<textarea id="address" rows="3"
placeholder="AquaGuard Foundation Solutions
375 Northridge Road
Atlanta GA 30350"></textarea>

<label>Service Type</label>
<select id="service">
  <option value="slab_piers">Slab Piers (Exempt)</option>
  <option value="helical_piers">Helical Piers</option>
  <option value="push_piers">Push Piers</option>
  <option value="wall_anchors">Wall Anchors (All Types)</option>
  <option value="other_structural">Other Structural Work</option>
</select>

<button class="primary" onclick="runCheck()">Check Permit</button>

<div style="margin-top:10px">
  <span class="tag" id="detected">Detected: —</span>
  <span class="tag" id="confidenceTag">Confidence: —</span>
</div>

<div class="confbar"><div id="confidenceBar"></div></div>

<div id="result" class="result hidden"></div>

<hr>

<button onclick="openQPublic()">Open qPublic</button>

<hr>

<h3>Export Audit PDF</h3>
<label>Inspector Name (CFI)</label>
<input id="inspName" placeholder="Mr. Mustache">

<label>Inspector Initials</label>
<input id="inspInit" placeholder="MM">

<button onclick="exportPDF()">Export PDF</button>

<div id="audit"></div>

</div>

<!-- INSTRUCTIONS -->
<div id="instructions" class="card hidden">
<h3>How This Tool Works</h3>
<ul>
  <li>Accepts full address, city-only, ZIP-only, or mixed input.</li>
  <li>City is displayed for clarity; county determines permit authority.</li>
  <li>Structural services generally require permits.</li>
  <li>Slab piers are exempt statewide.</li>
  <li>Confidence reflects data strength, not legality.</li>
</ul>
<p>
  <strong>Ruleset:</strong> AquaGuard Permit Instructions (1-22-2026)<br>
  <a href="Permit_Instructions_2026-01-22.pdf" target="_blank">
    View original permit instructions (PDF)
  </a>
</p>
</div>

<footer class="card">
  <img src="matthew-urbanski.PNG" class="creator" alt="Matthew Urbanski">
  <strong>Tool Created By</strong><br>
  Matthew Urbanski, CFI<br>
  <small>
    Internal decision-support tool for AquaGuard Foundation Solutions.<br>
    Always verify parcel jurisdiction using qPublic.
  </small>
  <br><br>
  <a href="Permit_Instructions_2026-01-22.pdf" target="_blank">
    View source permit instructions (PDF)
  </a>
</footer>

</div>

<script>
/* ---------------- CORE DATA ---------------- */

const PERMIT_COUNTIES = ["Cobb","Cherokee","Fulton","DeKalb","Gwinnett","Butts"];

const ZIP_TO_COUNTY = {
  "30080":"Cobb",
  "30152":"Cobb",
  "30115":"Cherokee",
  "30339":"Fulton",
  "30350":"Fulton"
};

/* ---------------- UI ---------------- */

function showTab(id, el){
  document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
}

function openQPublic(){
  window.open("https://qpublic.schneidercorp.com","_blank");
}

/* ---------------- GEOCODING ---------------- */

async function geocode(query){
  const url = "https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q="
    + encodeURIComponent(query);
  const res = await fetch(url);
  const json = await res.json();
  return json.length ? json[0] : null;
}

function clean(s){
  return s ? s.replace(/ County$/i,"").trim() : "";
}

function extractCity(addr){
  const keys=["city","town","municipality","suburb","locality","village","hamlet"];
  for(const k of keys){
    if(addr[k]) return clean(addr[k]);
  }
  return "";
}

function inferCityFromInput(text){
  if(/kennesaw/i.test(text)) return "Kennesaw";
  if(/smyrna/i.test(text)) return "Smyrna";
  if(/canton/i.test(text)) return "Canton";
  if(/atlanta/i.test(text)) return "Atlanta";
  return "";
}

/* ---------------- MAIN LOGIC ---------------- */

let auditData={};

async function runCheck(){
  const raw=document.getElementById("address").value.replace(/\s+/g," ").trim();
  const service=document.getElementById("service").value;

  let city="",county="",confidence="Low",score=30;

  try{
    const geo=await geocode(raw);
    if(geo){
      const a=geo.address||{};
      city=extractCity(a) || inferCityFromInput(raw);
      county=clean(a.county);
      const zip=a.postcode;
      if(!county && zip && ZIP_TO_COUNTY[zip]) county=ZIP_TO_COUNTY[zip];
    }

    if(city && county){confidence="High";score=90;}
    else if(county){confidence="Medium";score=60;}

    let decision="",msg="",type="warn";

    if(service==="slab_piers"){
      decision="No Permit Required";
      msg="Slab piers are exempt statewide.";
      type="ok";
    }else if(PERMIT_COUNTIES.includes(county)){
      decision="Permit Required";
      msg=`${county} County requires permits for this service.`;
      type="bad";
    }else{
      decision="Check / Try";
      msg="Jurisdiction unclear. Verify via qPublic.";
    }

    document.getElementById("detected").textContent =
      `Detected: ${city||"Unknown"}, ${county||"Unknown County"}`;
    document.getElementById("confidenceTag").textContent =
      `Confidence: ${confidence}`;
    updateBar(score,confidence);
    showResult(type,decision,msg);

    auditData={
      address:raw,
      city,
      county,
      confidence,
      service,
      decision,
      time:new Date().toLocaleString()
    };

    document.getElementById("audit").innerHTML =
      `<small><pre>${JSON.stringify(auditData,null,2)}</pre></small>`;

  }catch{
    showResult("warn","Check / Try","Unable to evaluate address.");
  }
}

function showResult(type,title,msg){
  const r=document.getElementById("result");
  r.className=`result ${type}`;
  r.innerHTML=`<strong>${title}</strong><br>${msg}`;
  r.classList.remove("hidden");
}

function updateBar(score,conf){
  const bar=document.getElementById("confidenceBar");
  bar.style.width=score+"%";
  bar.style.background =
    conf==="High"? "var(--green)" :
    conf==="Medium"? "var(--orange)" :
    "var(--red)";
}

/* ---------------- PDF ---------------- */

function exportPDF(){
  const name=document.getElementById("inspName").value;
  const init=document.getElementById("inspInit").value;
  if(!name||!init){alert("Inspector name and initials required.");return;}
  const {jsPDF}=window.jspdf;
  const d=new jsPDF();
  d.text("AquaGuard Permit Audit",10,10);
  d.text(`Inspector: ${name} (${init})`,10,20);
  d.text(JSON.stringify(auditData,null,2),10,30);
  d.save("permit_audit.pdf");
}
</script>

</body>
</html>
