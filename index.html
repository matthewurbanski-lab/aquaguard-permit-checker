<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AquaGuard Permit Checking Tool</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#0f172a;--card:#111827;--muted:#94a3b8;--text:#e5e7eb;
  --accent:#22c55e;--warn:#f97316;--danger:#ef4444;--ok:#10b981;
}
body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto;}
.container{max-width:960px;margin:0 auto;padding:16px;}
.header{text-align:center;margin:24px 0;}
.header img{max-width:100%;border-radius:12px;}
.card{background:var(--card);border-radius:12px;padding:16px;margin-bottom:16px;}
label{display:block;margin-top:10px;color:var(--muted);}
textarea,select,input{
  width:100%;padding:10px;border-radius:8px;
  border:1px solid #374151;background:#0b1220;color:var(--text);
}
textarea{min-height:90px;resize:vertical;}
button{padding:10px 14px;border-radius:8px;border:0;font-weight:600;cursor:pointer;}
.primary{background:var(--accent);color:#052e16;}
.ghost{background:#0b1220;border:1px solid #374151;color:var(--text);}
.result{margin-top:14px;padding:14px;border-radius:12px;}
.yes{background:rgba(239,68,68,.18);}
.no{background:rgba(16,185,129,.18);}
.maybe{background:rgba(249,115,22,.18);}
.tag{display:inline-block;margin-right:8px;padding:4px 8px;border-radius:999px;font-size:.75rem;border:1px solid #374151;color:var(--muted);}
.tabs{display:flex;gap:8px;margin-bottom:16px;}
.tab{padding:8px 12px;border-radius:8px;border:1px solid #374151;cursor:pointer;}
.tab.active{background:#0b1220;}
footer{font-size:.85rem;color:var(--muted);margin-top:24px;}
a{color:#93c5fd;text-decoration:none;}
</style>
</head>

<body>
<div class="container">

<div class="header">
  <img src="aquaguard-logo.PNG" alt="AquaGuard Permit Checking Tool">
</div>

<div class="tabs">
  <div class="tab active" onclick="showTab('checker')">Checker</div>
  <div class="tab" onclick="showTab('instructions')">Instructions</div>
</div>

<!-- CHECKER -->
<div id="checker">

<div class="card">
  <label>Inspector Name</label>
  <input id="inspectorName" placeholder="Full name">

  <label>Inspector Initials</label>
  <input id="inspectorInitials" placeholder="Initials (e.g. MU)">
</div>

<div class="card">
  <label>Property Address / City / ZIP (Georgia)</label>
  <textarea id="address"></textarea>

  <label>Work Type</label>
  <select id="work">
    <option value="structural">Structural Work</option>
    <option value="slab">Slab Piers</option>
  </select>

  <button class="primary" style="margin-top:12px" onclick="runCheck()">Check Permit</button>

  <div style="margin-top:10px">
    <span class="tag" id="detected">Detected: —</span>
    <span class="tag" id="confidence">Confidence: —</span>
  </div>

  <div id="result" class="result maybe" style="display:none"></div>
</div>

<div id="parcelCard" class="card" style="display:none">
  <strong>Parcel Number Lookup</strong>
  <p>Parcel numbers must be verified using qPublic.</p>
  <a href="https://qpublic.schneidercorp.com" target="_blank">Open qPublic</a>
</div>

<div id="auditCard" class="card" style="display:none">
  <strong>Decision Details (Audit Trail)</strong>
  <ul id="audit"></ul>

  <button class="ghost" onclick="exportPDF()">Export Audit as PDF</button>
</div>

</div>

<!-- INSTRUCTIONS -->
<div id="instructions" style="display:none">

<div class="card">
<h3>PDF Export</h3>
<p>
The exported PDF is a professional internal record containing:
</p>
<ul>
<li>Inspector name and initials</li>
<li>Property input</li>
<li>Detected jurisdiction</li>
<li>Confidence level and source</li>
<li>Permit decision and rule reasoning</li>
<li>Date and time of determination</li>
</ul>
<p>
This PDF supports internal review, compliance documentation, and recordkeeping.
</p>
</div>

</div>

<footer>
<strong>Ruleset:</strong> 1-22-2026<br><br>

<div style="display:flex;gap:12px;align-items:center;">
  <img src="matthew-urbanski.PNG" style="height:64px;border-radius:8px;">
  <div>
    <strong>Tool created by:</strong><br>
    Matthew Urbanski, CFI<br>
    <a href="mailto:Matthew.Urbanski@AquaGuard.net">Matthew.Urbanski@AquaGuard.net</a><br>
    <a href="tel:14705681681">470-568-1681</a>
  </div>
</div>

<br>
<a href="Permit_Instructions_2026-01-22.pdf" target="_blank">
View official permit instructions (PDF)
</a><br><br>

<small>Guidance only. Jurisdiction must be verified via qPublic.</small>
</footer>

</div>

<script>
const RULES={
  permitCounties:["Cobb","DeKalb","Fulton","Gwinnett","Cherokee","Butts"],
  alwaysPermitCities:["Atlanta","Stone Mountain"]
};
const ZIP_TO_COUNTY={"30115":"Cherokee","30339":"Cobb","30338":"DeKalb"};
const TRUST_THRESHOLD=0.35;
let auditData={};

function showTab(t){
  document.getElementById("checker").style.display=t==="checker"?"block":"none";
  document.getElementById("instructions").style.display=t==="instructions"?"block":"none";
  document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
  document.querySelectorAll(".tab")[t==="checker"?0:1].classList.add("active");
}
function cleanInput(r){return r.replace(/\n+/g," ").replace(/\s+/g," ").trim();}
function norm(s){return s?s.replace(/\b\w/g,c=>c.toUpperCase()):"";}

async function geocode(raw){
  const q=cleanInput(raw);
  const url=`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=1&countrycodes=us&state=Georgia&q=${encodeURIComponent(q)}`;
  const r=await fetch(url); const d=await r.json(); return d[0]||null;
}

async function runCheck(){
  const inspector=document.getElementById("inspectorName").value.trim();
  const initials=document.getElementById("inspectorInitials").value.trim();
  if(!inspector||!initials){alert("Inspector name and initials required.");return;}

  const raw=document.getElementById("address").value;
  const work=document.getElementById("work").value;
  const cleaned=cleanInput(raw);

  let city="",county="",confidence="Low",source="ZIP fallback";

  const geo=await geocode(raw);
  if(geo){
    city=norm(geo.address.city||geo.address.town||"");
    county=norm((geo.address.county||"").replace(" County",""));
    if(geo.importance>=TRUST_THRESHOLD){confidence="High";source="Geocoder";}
  }
  const zip=cleaned.match(/\b\d{5}\b/)?.[0];
  if((!county||confidence!=="High")&&ZIP_TO_COUNTY[zip]){
    county=ZIP_TO_COUNTY[zip];
    confidence="Medium";
  }

  let decision="Check / Try",reason="Jurisdiction unclear.";
  if(work==="slab"){decision="No Permit Required";reason="Slab piers exempt statewide.";}
  else if(RULES.alwaysPermitCities.includes(city)){decision="Permit Required";reason=`${city} always requires permits.`;}
  else if(RULES.permitCounties.includes(county)){decision="Permit Required";reason=`${county} County requires permits.`;}

  document.getElementById("detected").textContent=`Detected: ${city||"Unknown"}, ${county||"Unknown"} County`;
  document.getElementById("confidence").textContent=`Confidence: ${confidence} (${source})`;
  document.getElementById("result").style.display="block";
  document.getElementById("result").innerHTML=`<strong>${decision}</strong><br>${reason}`;
  document.getElementById("parcelCard").style.display="block";
  document.getElementById("auditCard").style.display="block";

  auditData={
    inspector,initials,cleaned,city,county,confidence,source,decision,reason,
    timestamp:new Date().toLocaleString()
  };
  document.getElementById("audit").innerHTML=Object.entries(auditData)
    .map(([k,v])=>`<li><strong>${k}:</strong> ${v}</li>`).join("");
}

function exportPDF(){
  const { jsPDF }=window.jspdf;
  const doc=new jsPDF();
  let y=15;

  doc.setFontSize(16);
  doc.text("AquaGuard Permit Audit Summary",105,y,{align:"center"});
  y+=10;

  doc.setFontSize(11);
  const section=(title,lines)=>{
    doc.setFont(undefined,"bold");
    doc.text(title,10,y); y+=6;
    doc.setFont(undefined,"normal");
    lines.forEach(l=>{
      const wrapped=doc.splitTextToSize(l,180);
      doc.text(wrapped,10,y);
      y+=wrapped.length*6;
    });
    y+=4;
  };

  section("Inspector",[
    `Name: ${auditData.inspector}`,
    `Initials: ${auditData.initials}`
  ]);
  section("Property Input",[auditData.cleaned]);
  section("Jurisdiction",[
    `City: ${auditData.city||"Unknown"}`,
    `County: ${auditData.county||"Unknown"}`,
    `Confidence: ${auditData.confidence} (${auditData.source})`
  ]);
  section("Decision",[
    `${auditData.decision}`,
    `Reason: ${auditData.reason}`
  ]);
  section("Timestamp",[auditData.timestamp]);

  doc.setFontSize(9);
  doc.text(
    "Guidance only. Jurisdiction and parcel information must be verified via qPublic.",
    10,285
  );

  doc.save(`permit-audit-${Date.now()}.pdf`);
}
</script>

</body>
</html>
