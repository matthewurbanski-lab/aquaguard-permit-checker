<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AquaGuard Permit Checking Tool</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
:root{
  --bg:#0b1220;
  --panel:#111827;
  --border:#1f2937;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --green:#22c55e;
  --orange:#f97316;
  --red:#ef4444;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
}
.container{
  max-width:920px;
  margin:auto;
  padding:16px;
}
.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:14px;
  padding:16px;
  margin-bottom:16px;
}
img.logo{
  display:block;
  margin:0 auto 12px;
  max-width:280px;
}
.tabs{
  display:flex;
  gap:10px;
  margin-bottom:12px;
}
.tab{
  flex:1;
  padding:10px;
  text-align:center;
  border:1px solid var(--border);
  border-radius:10px;
  cursor:pointer;
}
.tab.active{background:#020617}
.hidden{display:none}
label{display:block;margin:10px 0 4px;color:var(--muted)}
textarea,input,select,button{
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid var(--border);
  background:#020617;
  color:var(--text);
}
button.primary{
  background:var(--green);
  color:#052e16;
  font-weight:700;
  border:none;
  margin-top:10px;
}
.tag{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  border:1px solid var(--border);
  font-size:.8rem;
  margin-right:6px;
}
.result{
  margin-top:12px;
  padding:14px;
  border-radius:12px;
}
.result.ok{background:rgba(34,197,94,.15)}
.result.warn{background:rgba(249,115,22,.15)}
.result.bad{background:rgba(239,68,68,.15)}
.confbar{
  height:10px;
  background:#1f2937;
  border-radius:999px;
  overflow:hidden;
  margin-top:6px;
}
.confbar > div{height:100%;width:0;transition:.4s}
small{color:var(--muted)}
hr{border:0;border-top:1px solid var(--border);margin:16px 0}
</style>
</head>

<body>
<div class="container">

<!-- LOGO (case-correct) -->
<img src="aquaguard-logo.PNG" class="logo" alt="AquaGuard Foundation Solutions">

<div class="tabs">
  <div class="tab active" onclick="showTab('checker')">Checker</div>
  <div class="tab" onclick="showTab('instructions')">Instructions</div>
</div>

<!-- CHECKER -->
<div id="checker" class="card">

<label>Property Address / City / ZIP (Georgia)</label>
<textarea id="address" rows="3"
placeholder="706 Springs Street Smyrna GA 30080"></textarea>

<label>Service Type</label>
<select id="service">
  <option value="slab_piers">Slab Piers (Exempt)</option>
  <option value="helical_piers">Helical Piers</option>
  <option value="push_piers">Push Piers</option>
  <option value="wall_anchors">Wall Anchors (All Types)</option>
  <option value="other_structural">Other Structural Work</option>
</select>

<button class="primary" onclick="runCheck()">Check Permit</button>

<div style="margin-top:10px">
  <span class="tag" id="detected">Detected: —</span>
  <span class="tag" id="confidenceTag">Confidence: —</span>
</div>

<div class="confbar">
  <div id="confidenceBar"></div>
</div>

<div id="result" class="result hidden"></div>

<hr>

<button onclick="openQPublic()">Open qPublic</button>

<hr>

<h3>Export Audit PDF</h3>
<label>Inspector Name (CFI)</label>
<input id="inspName" placeholder="Matthew Urbanski">

<label>Inspector Initials</label>
<input id="inspInit" placeholder="MU">

<button onclick="exportPDF()">Export PDF</button>

<div id="audit"></div>

</div>

<!-- INSTRUCTIONS -->
<div id="instructions" class="card hidden">
<h3>How This Tool Works</h3>
<ul>
  <li>Paste a full address, city, ZIP, or any combination.</li>
  <li>City detection includes suburb, locality, and neighborhood.</li>
  <li>Structural services typically require permits.</li>
  <li>Slab piers are exempt statewide per AquaGuard policy.</li>
  <li>Confidence reflects data strength, not legality.</li>
  <li>Always verify parcel data in qPublic.</li>
</ul>
<p><strong>Ruleset:</strong> AquaGuard Permit Instructions (1-22-2026)</p>
<a href="Permit_Instructions_2.pdf" target="_blank">
View official permit instructions (PDF)
</a>
</div>

</div>

<script>
function showTab(id){
  document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  event.target.classList.add('active');
}

const PERMIT_COUNTIES=["Cobb","Cherokee","Fulton","DeKalb","Gwinnett","Butts"];

const ZIP_TO_COUNTY={
  "30080":"Cobb",
  "30115":"Cherokee",
  "30339":"Fulton"
};

function normalize(s){
  return s ? s.replace(/ County$/i,"").trim() : "";
}

function extractCity(addr){
  const keys=[
    "city","town","municipality","suburb",
    "village","locality","neighbourhood","hamlet"
  ];
  for(const k of keys){
    if(addr[k]) return normalize(addr[k]);
  }
  return "";
}

async function geocode(q){
  const url=`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(q)}`;
  const r=await fetch(url);
  const j=await r.json();
  return j[0];
}

let auditData={};

async function runCheck(){
  const raw=document.getElementById("address").value.replace(/\s+/g," ").trim();
  const service=document.getElementById("service").value;

  let city="",county="",confidence="Low",score=30;

  try{
    const geo=await geocode(raw);
    const a=geo.address||{};
    city=extractCity(a);
    county=normalize(a.county);
    const zip=a.postcode;

    if(!county && zip && ZIP_TO_COUNTY[zip]){
      county=ZIP_TO_COUNTY[zip];
      confidence="Medium";score=60;
    }
    if(city && county){
      confidence="High";score=90;
    }

    let decision="",msg="";
    if(service==="slab_piers"){
      decision="No Permit Required";
      msg="Slab piers are exempt statewide.";
      showResult("ok",decision,msg);
    }else if(PERMIT_COUNTIES.includes(county)){
      decision="Permit Required";
      msg=`${county} County requires permits for this service.`;
      showResult("bad",decision,msg);
    }else{
      decision="Check / Try";
      msg="Jurisdiction unclear. Verify via qPublic.";
      showResult("warn",decision,msg);
    }

    document.getElementById("detected").textContent=
      `Detected: ${city||"Unknown"}, ${county||"Unknown County"}`;
    document.getElementById("confidenceTag").textContent=
      `Confidence: ${confidence}`;
    updateBar(score,confidence);

    auditData={address:raw,city,county,confidence,service,decision,time:new Date().toLocaleString()};
    document.getElementById("audit").innerHTML=
      `<small><pre>${JSON.stringify(auditData,null,2)}</pre></small>`;

  }catch{
    showResult("warn","Check / Try","No geocoder match.");
  }
}

function updateBar(score,conf){
  const bar=document.getElementById("confidenceBar");
  bar.style.width=score+"%";
  bar.style.background=
    conf==="High"? "var(--green)" :
    conf==="Medium"? "var(--orange)" :
    "var(--red)";
}

function showResult(type,title,msg){
  const r=document.getElementById("result");
  r.className=`result ${type}`;
  r.innerHTML=`<strong>${title}</strong><br>${msg}`;
  r.classList.remove("hidden");
}

function openQPublic(){
  window.open("https://qpublic.schneidercorp.com","_blank");
}

function exportPDF(){
  const name=document.getElementById("inspName").value;
  const init=document.getElementById("inspInit").value;
  if(!name||!init){
    alert("Inspector name and initials required.");
    return;
  }
  const {jsPDF}=window.jspdf;
  const d=new jsPDF();
  d.text("AquaGuard Permit Audit",10,10);
  d.text(`Inspector: ${name} (${init})`,10,20);
  d.text(JSON.stringify(auditData,null,2),10,30);
  d.save("permit_audit.pdf");
}
</script>

</body>
</html>
